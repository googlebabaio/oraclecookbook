
<!-- toc -->

* * * * *
# 配置多活方案--duplicate + active database
## 一、各备库配置静态监听、tnsnames
- grid用户配置listener.ora
- oracle用户配置tnsnames.ora
- 配置完成后用tnsping做测试

```
亦庄新库（新增）- tyqxsh
VIP：10.4.80.19/20
SCAN IP：10.4.80.21:11521

授权库（新增）- iscsqdb
VIP：10.1.150.52/53
SCAN IP：10.1.150.54:11521

认证库（新增）- iscrzdb
VIP：10.1.150.55/56
SCAN IP：10.1.150.57:11521
```

## 二、修改主库的dg参数
```
alter system set LOG_ARCHIVE_CONFIG='DG_CONFIG=(iscdb,tyqxsh,iscsqdb,iscrzdb)' sid='*';
alter system set LOG_ARCHIVE_DEST_3='SERVICE=tyqxsh ARCH VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=tyqxsh' sid='*';
alter system set LOG_ARCHIVE_DEST_4='SERVICE=iscsqdb ARCH VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=iscsqdb' sid='*';
alter system set LOG_ARCHIVE_DEST_5='SERVICE=iscrzdb ARCH VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=iscrzdb' sid='*';
alter system set LOG_ARCHIVE_DEST_STATE_3=ENABLE sid='*';
alter system set LOG_ARCHIVE_DEST_STATE_4=ENABLE sid='*';
alter system set LOG_ARCHIVE_DEST_STATE_5=ENABLE sid='*';

alter system set fal_server=tyqxsh,iscsqdb,iscrzdb sid='*';
alter system set standby_file_management=auto sid='*';

db_file_name_convert
log_file_name_convert
```

修改完成后,创建pfile:
```
create pfile='/home/oracle/pfile20181229.ora' from spfile;
```
将创建好的pfile传到备库进行修改

## 三、修改备库的pfile，并启动数据库到nomount状态
主要修改的参数有：
- local_listener
- remote_listener
- dn_name
- db_unique_name
- service_names
- instance_number
- control_files
- log_archive_dest_1
- log_archive_dest_2
- sga/pga/process
- db_file_name_convert
- log_file_name_convert
- fal_server=XXXX

>根据参数创建必要的目录,如audit的目录等

修改完成后，备库启动实例到nomount状态
```
startup nomount pfile='/home/oracle/pfile20181229.ora';
```

注意：这个地方要是用pfile的形式

## 四、传递主库的密码文件到备库
```
scp $ORACLE_HOME/dbs/orapwxxxx 备库的$ORACLE_HOME/dbs/orapwxxxxx
```

## 五、开始在线复制备库
```
rman target sys/passwd@iscdb auxiliary sys/passwd@dg-tnsnames
run
{
allocate channel ch001 type disk;
allocate channel ch002 type disk;
allocate channel ch003 type disk;
allocate channel ch004 type disk;
allocate auxiliary channel ch005 type disk;
allocate auxiliary channel ch006 type disk;
allocate auxiliary channel ch007 type disk;
allocate auxiliary channel ch008 type disk;
duplicate target database for standby from active database;
release channel ch001;
release channel ch002;
release channel ch003;
release channel ch004;
release channel ch005;
release channel ch006;
release channel ch007;
release channel ch008;
}
```

## 六、备库添加standby redo log
```
ALTER DATABASE ADD STANDBY LOGFILE thread 1 GROUP 9 ('+DATA','+ARCH') size 1G;
ALTER DATABASE ADD STANDBY LOGFILE thread 1 GROUP 10 ('+DATA','+ARCH')size 1G;
ALTER DATABASE ADD STANDBY LOGFILE thread 1 GROUP 11 ('+DATA','+ARCH')  size 1G;
ALTER DATABASE ADD STANDBY LOGFILE thread 1 GROUP 12 ('+DATA','+ARCH')  size 1G;
ALTER DATABASE ADD STANDBY LOGFILE thread 1 GROUP 13 ('+DATA','+ARCH')  size 1G;

ALTER DATABASE ADD STANDBY LOGFILE thread 2 GROUP 14 ('+DATA','+ARCH')  size 1G;
ALTER DATABASE ADD STANDBY LOGFILE thread 2 GROUP 15 ('+DATA','+ARCH')  size 1G;
ALTER DATABASE ADD STANDBY LOGFILE thread 2 GROUP 16 ('+DATA','+ARCH')  size 1G;
ALTER DATABASE ADD STANDBY LOGFILE thread 2 GROUP 17 ('+DATA','+ARCH')  size 1G;
ALTER DATABASE ADD STANDBY LOGFILE thread 2 GROUP 18 ('+DATA','+ARCH')  size 1G;
```

## 七、备库做open并且开启real apply
```
alter database recover managed standby database using current logfile disconnect from session;
```
等待一会儿追归档
```
shutdown immediate;
startup;
alter database recover managed standby database using current logfile disconnect from session;
```

## 八、做CRS资源注册，启动双节点数据库
```
$ srvctl add database -d xxx -o $ORACLE_HOME -p +ORADATA/sidname/spfile.ora -r physical_standby
$ srvctl add instance -d xxx -n xxx1 -i xxx1
$ srvctl add instance -d xxx -n xxx2 -i xxx2
```

## 九、在第二、三个备库重复执行执行第[三]至[八]步

## 十、注意点:
- 1.配置静态监听
- 2.修改pfile，启动到nomount状态
- 3.利用`duplicate target database for standby from active database;`进行恢复
- 4.在备库上添加`standby redo log`
- 5.做CRS资源注册，启动双节点数据库
